---

# 🚀 Worker 智能部署中控 (Worker Command Center)

**版本:** V7.3

**核心功能:** 多账号管理 / 多项目一键部署 / 自动更新 / 流量监控 / 智能变量配置

这是一个运行在 Cloudflare Worker 上的“中控台”程序。它允许您在一个统一的面板中管理多个 Cloudflare 账号，并一键将常用的代理脚本（如 CMliu、Joey、ECH）部署到这些账号下的 Worker 中。

---

## ✨ 主要功能

### 1. 多账号与多项目管理

* **多账号支持**: 可以添加多个 Cloudflare 账号（通过 Account ID 和 API Token）。
* **多项目支持**: 目前支持一键部署以下三种脚本：
* **🔴 CMliu (EdgeTunnel)**: 经典的 VLESS/Trojan 部署方案。
* **🔵 Joey (少年你相信光吗)**: 自动修复与节点优化的脚本。
* **🟢 ECH (WebSocket Proxy)**: 支持 ECH 方案的 WebSocket 代理。



### 2. 智能变量与配置管理

* **可视化编辑**: 在面板中直接增删改 Worker 的环境变量，无需进入 Cloudflare 后台。
* **智能辅助输入 (V7.3 新增)**:
* **PROXYIP**: 提供全球节点（亚洲/欧洲/北美）下拉选择，自动添加 `:443` 端口。
* **DOH**: 提供常用 DOH 地址（如 `dns.jhb.ovh` 等）下拉选择。


* **配置同步**: 支持从已部署的 Worker 中反向读取配置到面板，方便迁移。
* **UUID 一键轮换**: 支持一键生成新的 UUID 并自动重新部署。

### 3. 自动化与监控

* **自动更新**: 通过 Cron 触发器，定期检查 GitHub 上游代码更新。如果发现新版本，会自动拉取并重新部署所有关联的 Worker。
* **流量监控**: 实时显示每个账号当天的请求数流量及使用百分比。
* **熔断机制**: 当账号流量达到设定阈值时，自动轮换 UUID 或停止服务（需配置）。

### 4. 用户体验优化

* **UI 自适应**: 完美适配手机和电脑端，日志窗口自动调整位置。
* **PWA 支持**: 支持添加到手机主屏幕，像原生 App 一样使用。
* **部署日志**: 实时显示部署状态、成功/失败信息及错误原因。

---

## 🛠️ 部署指南

### 第一步：准备工作

1. 拥有一个 **Cloudflare 账号**。
2. 准备好目标账号的 **Account ID** 和 **API Token**（权限要求见下文）。

### 第二步：创建 KV Namespace (必须)

此脚本严重依赖 KV 存储来保存账号信息和配置。

1. 在 Cloudflare 面板左侧菜单点击 **Storage & Databases** -> **KV**。
2. 点击 **Create Namespace**。
3. 命名为 `WORKER_CONFIG` (或者你喜欢的名字)。
4. 点击 **Add**。

### 第三步：部署 Worker

1. 创建一个新的 Worker (例如命名为 `admin-panel`)。
2. 点击 **Settings** -> **Variables**。
3. **绑定 KV Namespace**:
* 在 **KV Namespace Bindings** 区域点击 `Add binding`。
* **Variable name (变量名)** 必须填写: `CONFIG_KV` (注意：必须完全一致，否则无法保存数据)。
* **KV Namespace**: 选择上一步创建的 `WORKER_CONFIG`。


4. **添加环境变量** (可选但推荐):
* `ACCESS_CODE`: 设置一个访问密码（防止他人访问你的面板）。
* `GITHUB_TOKEN`: (可选) 如果你需要频繁检查更新，建议提供 GitHub Token 以避免 API 限制。


5. 点击 **Edit code**，将 `worker.js` 的所有代码粘贴进去。
6. 点击 **Deploy**。

### 第四步：配置 Cron (定时任务)

为了让自动更新和流量监控生效，需要设置 Cron。

1. 在 Worker 的 **Settings** -> **Triggers** 页面。
2. 点击 **Add Cron Trigger**。
3. 推荐设置: `*/30 * * * *` (每 30 分钟执行一次)。
4. 保存。

---

## ⚙️ 变量设置说明

### 1. Worker 自身的环境变量

| 变量名 | 必填 | 说明 |
| --- | --- | --- |
| `CONFIG_KV` | **是** | **KV 绑定名称**。必须绑定到一个 KV 空间，用于存储账号和配置。 |
| `ACCESS_CODE` | 否 | 面板的访问密码。如果不设置，任何人知道网址都能访问。 |
| `GITHUB_TOKEN` | 否 | 用于请求 GitHub API。不填容易触发速率限制导致无法检查更新。 |

### 2. 被控账号的 API Token 权限

在添加账号时，填写的 API Token 需要具备以下权限：

* **Workers Scripts**: `Edit` (用于读写 Worker 代码和变量)
* **Account Settings**: `Read` (用于读取账号流量统计)
* **User Details**: `Read` (可选，部分统计功能可能需要)

---

## 📖 使用教程

### 1. 添加账号

1. 进入面板，输入密码登录。
2. 点击右上角的 **“➕ 添加账号”**。
3. 填写 **备注**、**Account ID** 和 **API Token**。
4. 在对应的项目栏（如 CMliu Workers）填写你希望该账号下哪个 Worker 被接管。
* *例如：如果不填写，脚本不会自动创建 Worker，你需要在该账号下先创建一个 Worker，然后把名字填在这里。*


5. 点击 **“💾 保存账号”**。

### 2. 部署项目

1. 在右侧（或手机端下方）的项目卡片中（如 🔴 CMliu 配置），点击 **“➕ 变量”** 添加必要的变量（如 `UUID`, `PROXYIP` 等）。
2. 利用下拉菜单快速选择 `PROXYIP` 或 `DOH`。
3. 点击 **“🚀 部署 CMliu”**。
4. 观察顶部的日志窗口，显示 `✅ 更新成功` 即完成。

### 3. 自动更新设置

1. 在顶部控制栏，勾选 **“自动检测”**。
2. 设置间隔时间（如 30 分钟）。
3. 点击 **“保存”**。
4. 只要配置了 Cron 触发器，系统就会在后台自动检查。

---

## ⚠️ 注意事项与常见问题

1. **KV 绑定名称**: 请务必确保 KV 的绑定变量名为 `CONFIG_KV`，否则脚本会报错 `env.CONFIG_KV is null`。
2. **首次部署**:
* 本脚本**不会自动创建**目标 Worker。请确保目标账号下已经存在对应名字的 Worker（哪怕是空的 Hello World）。
* 添加账号时，填写的 Worker 名称必须与目标账号下实际存在的 Worker 名称一致。


3. **ECH 项目**:
* ECH 项目的 `PROXYIP` 是直接写入代码中的（硬编码），而不是作为环境变量上传。部署时面板会自动处理替换。


4. **Joey 项目**:
* 脚本会自动为 Joey 项目添加 `var window = globalThis;` 的补丁，以防止代码报错。


5. **熔断机制**:
* 如果开启了熔断（设置了阈值），当流量超标时，脚本会自动轮换 UUID。这会导致旧的节点连接失效，从而达到阻断流量的目的。



---

**免责声明**: 本脚本仅供学习与技术研究使用，请勿用于非法用途。使用本脚本所产生的任何后果由使用者自行承担。
